<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>用户注册登录</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
  <style>
    .form-card { max-width: 500px; margin: 50px auto; }
    .tab-content { padding: 20px 0; }
    .alert { margin-top: 15px; display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card form-card">
      <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#register">注册</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#login">登录</a></li>
        </ul>
      </div>
      <div class="card-body">
        <div class="tab-content">
          <!-- 注册表单 -->
          <div class="tab-pane fade show active" id="register">
            <h5 class="card-title text-center mb-4">注册成书易VIP，免费指导单招院校</h5>
            <form id="registerForm">
              <div class="mb-3">
                <label class="form-label">姓名</label>
                <input type="text" class="form-control" name="name" placeholder="请输入姓名" required>
              </div>
              <div class="mb-3">
                <label class="form-label">手机号</label>
                <input type="tel" class="form-control" name="phone" placeholder="请输入11位手机号" required>
              </div>
              <button type="submit" class="btn btn-primary w-100">提交注册</button>
            </form>
            <div id="registerAlert" class="alert"></div>
          </div>

          <!-- 登录表单 -->
          <div class="tab-pane fade" id="login">
            <h5 class="card-title text-center mb-4">欢迎您，尊贵的书易VIP</h5>
            <form id="loginForm">
              <div class="mb-3">
                <label class="form-label">姓名</label>
                <input type="text" class="form-control" name="name" placeholder="请输入注册姓名" required>
              </div>
              <div class="mb-3">
                <label class="form-label">手机号</label>
                <input type="tel" class="form-control" name="phone" placeholder="请输入注册手机号" required>
              </div>
              <button type="submit" class="btn btn-success w-100">登录</button>
            </form>
            <div id="loginAlert" class="alert"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 初始化 Supabase
    const SUPABASE_URL = 'https://xxntbizfeyvpaasftlux.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bnRiaXpmZXl2cGFhc2Z0bHV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODg4NjQsImV4cCI6MjA4NTc2NDg2NH0.Mu-Pj297Zd-tJ9tF2DTARXgijcvQGQBJsMBAX0y3VSo';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      global: { fetch: (url, options = {}) => { options.credentials = 'omit'; return fetch(url, options); } }
    });

    // 注册逻辑
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const name = form.name.value.trim();
      const phone = form.phone.value.trim();
      const alertEl = document.getElementById('registerAlert');

      if (!/^1[3-9]\d{9}$/.test(phone)) {
        alertEl.className = 'alert alert-danger';
        alertEl.textContent = '请输入有效的11位手机号';
        alertEl.style.display = 'block';
        return;
      }

      try {
        const { data, error } = await supabase.from('user_info').insert([{ name, phone }]).select();
        if (error) {
          alertEl.className = 'alert alert-danger';
          alertEl.textContent = error.message.includes('unique constraint') ? '该手机号已注册' : `注册失败：${error.message}`;
          alertEl.style.display = 'block';
          return;
        }

        // 注册成功：1. 写入登录状态 2. 跳转
        localStorage.setItem('userLoginStatus', 'true'); // 写入登录标识
        localStorage.setItem('userName', name); // 可选：存储用户名
        alertEl.className = 'alert alert-success';
        alertEl.textContent = '注册成功！即将跳转到单招咨询页面...';
        alertEl.style.display = 'block';
        form.reset();
        setTimeout(() => { window.location.href = 'shuyi.html'; }, 1500);
      } catch (err) {
        alertEl.className = 'alert alert-danger';
        alertEl.textContent = `网络错误：${err.message}`;
        alertEl.style.display = 'block';
      }
    });

    // 登录逻辑
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const name = form.name.value.trim();
      const phone = form.phone.value.trim();
      const alertEl = document.getElementById('loginAlert');

      try {
        const { data, error } = await supabase.from('user_info').select('*').eq('phone', phone).eq('name', name).single();
        if (error) {
          alertEl.className = 'alert alert-danger';
          alertEl.textContent = error.code === 'PGRST116' ? '姓名或手机号错误' : `登录失败：${error.message}`;
          alertEl.style.display = 'block';
          return;
        }

        // 登录成功：1. 写入登录状态 2. 跳转
        localStorage.setItem('userLoginStatus', 'true'); // 核心：登录标识
        localStorage.setItem('userName', data.name); // 可选：存储用户名
        alertEl.className = 'alert alert-success';
        alertEl.textContent = `登录成功！欢迎 ${data.name}，即将跳转到单招咨询页面...`;
        alertEl.style.display = 'block';
        form.reset();
        setTimeout(() => { window.location.href = 'shuyi.html'; }, 1500);
      } catch (err) {
        alertEl.className = 'alert alert-danger';
        alertEl.textContent = `网络错误：${err.message}`;
        alertEl.style.display = 'block';
      }
    });
  </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"0d390eaa32dc4bf9a297f31d3850d355","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>